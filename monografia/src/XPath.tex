\chapter{XPath e XPath Injection} \label{chap:XPath}
A maioria das aplicações \estrangeiro{web} utilizam sistemas gerenciadores de bancos de dados (SGBD) para armazenar seus dados\cite{devWorks:XPath}, especialmente porque esses sistemas ajudam a garantir a integridade e facilitam a manipulação das informações armazenadas. Porém, utilizar um SGBD nem sempre é a melhor solução. Manter um SGBD não é uma tarefa barata. É preciso um especialista em cada SGBD utilizado, monitoramento constante, aquisição de servidores e até mesmo licenças de uso desses sistemas, etc. Para uma aplicação pequena, por exemplo, esses gastos não compensariam. Também, se alguma customização for feita para um caso específico, não compensaria alterar a estrutura da base de dados da aplicação para contemplar esse único caso. Para esses tipos de situações, documentos XML se tornam uma opção interessante, com a vantagem de serem legíveis para a aplicação e para seus usuários e desenvolvedores.

As seções seguintes introduzem a linguagem \estrangeiro{XPath}, utilizada para realizar consultas em documentos XML, e apresentam as vulnerabilidades do tipo \estrangeiro{XPath Injection}.

\section{Entendendo o XPath}
A XML Path Language, ou XPath, como é mais conhecida, é uma linguagem de consulta capaz de localizar elementos de um documento XML e até mesmo realizar cálculos com esses elementos\cite{W3C:XPath}.

Em uma consulta XPath, o documento XML é visto como uma árvore, onde cada \estrangeiro{tag}, cada atributo, cada texto, cada comentário, etc. é tratado como um nó\cite{W3Schools:XPath}. A linguagem XPath permite navegar por essa árvore, selecionando um conjunto de nós baseado em uma série de critérios. Desde 1999, XPath é uma recomendação da W3C\cite{W3C:XPath}. Suas principais expressões são:
\begin{description*}
  \item[\textit{nome}] - Seleciona todos os nós com o nome dado
  \item[/] - Seleciona a partir do nó atual
  \item[//] - Seleciona todos os nós do documento que satisfaçam o critério, partindo do atual
  \item[.] - Seleciona o nó atual
  \item[..] - Seleciona o pai do nó atual
  \item[@] - Seleciona um atributo
\end{description*}

Considere o documento XML da figura \ref{fig:ExemploXPath}, extraído de uma aplicação real. Este documento é utilizado para controlar a aprovação de cotações de compra em um sistema ERP (\estrangeiro{Enterprise Resource Planning}, sistemas integrados de gestão empresarial), baseando-se no valor da cotação. Cada elemento VALOR lista os logins dos usuários que podem aprovar cotações com valores iguais ou inferiores ao definido valor pelo atributo VALUE. No caso, o usuário EMILY pode aprovar cotações de até R\$500, o usuário TANIA pode aprovar cotações de até R\$999 e o usuário CHRISTIAN  pode aprovar cotações de até R\$1.000.000.

\figura{ExemploXPath}{Documento XML de exemplo para consultas}{7cm}

A seguir estão algumas das principais expressões XPath aplicadas ao documento XML da figura \ref{fig:ExemploXPath}, junto de seus resultados:
\begin{description*}
  \item[VALCOMPRAS]\hfill \\
    Seleciona todos os filhos do elemento raiz (VALCOMPRAS)
  \item[/VALCOMPRAS]\hfill \\
    Seleciona o elemento raiz
  \item[VALCOMPRAS/VALOR]\hfill \\
    Seleciona todos os elementos VALOR filhos diretos de VALCOMPRAS
  \item[VALCOMPRAS//USER]\hfill \\
    Seleciona todos os elementos USER descendentes de VALCOMPRAS. Não é necessário ser um filho direto
  \item[//@VALUE]\hfill \\
    Seleciona todos os atributos VALUE do documento
\end{description*}
Observe que as expressões são utilizadas para criar caminhos através do documento XML, daí o nome \textit{XML Path Language} (Linguagem de Caminhos pelo documento XML).

Para tornar o caminho até determinado elemento mais específico, é possível filtrar as expressões. A seguir estão alguns exemplos de filtros (expressões entre colchetes) aplicados ao documento da figura \ref{fig:ExemploXPath} e o resultado da consulta.
\begin{description*}
  \item[VALCOMPRAS/VALOR[1]]\hfill \\
    Seleciona o primeiro elemento VALOR filho de VALCOMPRAS
  \item[VALCOMPRAS/VALOR[last()]]\hfill \\
    Seleciona o último elemento VALOR filho de VALCOMPRAS
  \item[VALCOMPRAS/VALOR[position() <= 2]]\hfill \\
    Seleciona os dois primeiros elementos VALOR filhos de VALCOMPRAS
  \item[//VALOR[@VALUE]]\hfill \\
    Seleciona todos os elementos VALOR que possuam um atributo VALUE
  \item[//USERS[USER]]\hfill \\
    Seleciona todos os elementos USERS que tenham uma tag USER como filho
  \item[VALCOMPRAS/VALOR[@VALUE >= 1000]//USER]\hfill \\
    Seleciona todos os elementos USER que descendentes de um elemento VALOR com o atributo VALUE maior ou igual a 1000
  \item[//VALOR[@VALUE < 100 or @VALUE > 500]]\hfill \\
    Seleciona todos os elementos VALOR que tenham o elemento VALUE menor que 100 ou maior que 500
\end{description*}

\section{XPath Injection}
Segundo \cite{WASC:XPath}, XPath Injection é uma técnica para explorar aplicações que montam consultas XPath a partir de dados fornecidos pelo usuário. É uma forma de vulnerabilidade de injeção de código.

O código na figura \ref{fig:ExemploCSharp}, escrito em C\#, mostra uma aplicação que consulta o documento XML da figura \ref{fig:ExemploXPath} para obter uma lista com todos os usuários que podem aprovar cotações de compra de um determinado valor.

\figura{ExemploCSharp}{Código C\# executando uma consulta XPath}{13cm}

Na linha 3 é feita a consulta XPath baseando-se no valor de um campo de entrada. Supondo que a cotação de compras seja de R\$1000, essa consulta ficaria ``\texttt{//VALOR[@VALUE >= 1000]/USERS/USER/@NAME}'' o que retorna a lista de nomes corretamente.

Como não existe nenhuma validação deste campo antes de seu uso, o usuário pode informar qualquer conteúdo para este campo. Por exemplo, se o parâmetro tiver o formato 1000 or 1 = 1, a consulta ficaria ``\texttt{//VALOR[@VALUE >= 1000 or 1 = 1]/USERS/USER/@NAME}'' retornando os nomes de todos os usuários no documento, independente do valor permitido, já que a condição 1 = 1 será sempre verdadeira.

Estudos da WASC\cite{WASC:Statistics} encontraram 64 vulnerabilidades do tipo \estrangeiro{XPath Injection} em 19 aplicações. Nenhuma delas foi detectada pelos \estrangeiro{scanners} de vulnerabilidade utilizados por eles. Essa vulnerabilidade possui nota 10 (de um máximo de 10) utilizando o sistema CVSS (\estrangeiro{Common Vulnerability Scoring System}, sistema que compara os efeitos causados pelas vulnerabilidades - quanto mais grave a vulnerabilidade, maior a nota - e é classificada como \emph{urgente} pelo \estrangeiro{Payment Card Industry Security Standards Council} (grupo que define padrões de segurança para empresas que lidam com dados de cartões de crédito e débito - quanto maior a prioridade, mais grave a vulnerabilidade)\cite{PCI-DSS}. Portanto, nos dois sistemas o \emph{XPath Injection} é considerado uma vulnerabilidade grave.

\section{Evitando XPath Injection}
A melhor maneira de evitar este tipo de ataque é assumir que todos os dados de entrada são suspeitos e precisam ser validados antes de serem utilizados na consulta XPath. Algumas possíveis validações:
\begin{enumerate}
	\item Se os dados forem numéricos, verificar se apenas números e separadores de milhar e decimal estão presentes;
	\item Verificar a presença de aspas no texto e removê-las;
	\item Remover qualquer operador do XPath que exista nos dados de entrada;
\end{enumerate}

A figura \ref{fig:valid1} mostra uma forma de eliminar a vulnerabilidade da figura \ref{fig:ExemploCSharp}(linha 3), garantindo que o valor de entrada seja um número.

\figura{valid1}{Código C\# corrigido}{9cm}